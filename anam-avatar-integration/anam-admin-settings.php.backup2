<?php
/**
 * Plugin Name: Anam on WordPress - Admin Settings
 * Description: WordPress admin interface for configuring Anam.ai avatar settings
 * Version: 1.0.0
 * Author: Shawn Kelshaw
 * Plugin URI: https://github.com/shawnkelshaw/anam-on-wordpress
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Load refactored classes
require_once(plugin_dir_path(__FILE__) . 'includes/class-database.php');
require_once(plugin_dir_path(__FILE__) . 'includes/class-ajax-handlers.php');

// Include transcript handler (safe - will self-disable if feature flag is off)
require_once(plugin_dir_path(__FILE__) . 'anam-transcript-handler.php');

// Sessions admin page disabled - functionality removed
// require_once(plugin_dir_path(__FILE__) . 'anam-sessions-admin.php');

class AnamAdminSettings {
    
    private $option_group = 'anam_settings';
    private $option_name = 'anam_options';
    
    public function __construct() {
        $this->plugin_dir = plugin_dir_path(__FILE__);
        
        // Register AJAX handlers (now handled by separate class)
        Anam_Ajax_Handlers::register_hooks();
        
        // Hook into WordPress
        add_action('admin_menu', array($this, 'add_admin_menu'));
        add_action('admin_init', array($this, 'init_settings'));
        add_action('wp_footer', array($this, 'add_avatar_integration'));
        add_action('admin_enqueue_scripts', array($this, 'enqueue_admin_scripts'));
        add_action('admin_notices', array($this, 'show_config_changed_notice'));
        add_action('template_redirect', array($this, 'disable_page_caching'));
        
        // Create database table on plugin activation (now handled by Database class)
        register_activation_hook(__FILE__, array('Anam_Database', 'create_table'));
        
        // Also create table on init if it doesn't exist
        add_action('init', array('Anam_Database', 'ensure_table_exists'));
    }
    
    // Database methods moved to includes/class-database.php
    
    public function add_admin_menu() {
        // Add top-level menu (with Getting Started as default page)
        add_menu_page(
            'Anam Avatar',
            'Anam Avatar',
            'manage_options',
            'anam-avatar', // Parent slug
            array($this, 'getting_started_page'),
            'dashicons-admin-users', // Robot/user icon
            5 // Position
        );
        
        // Add Getting Started submenu (first in list, same slug as parent)
        add_submenu_page(
            'anam-avatar',
            'Getting Started',
            'Getting Started',
            'manage_options',
            'anam-avatar', // Same as parent - this makes it first
            array($this, 'getting_started_page')
        );
        
        // Add Avatar Setup submenu (settings)
        add_submenu_page(
            'anam-avatar',
            'Avatar Setup',
            'Avatar Setup',
            'manage_options',
            'anam-settings',
            array($this, 'admin_page')
        );
        
        // Add Display Settings submenu
        add_submenu_page(
            'anam-avatar',
            'Display Settings',
            'Display Settings',
            'manage_options',
            'anam-display-settings',
            array($this, 'display_settings_page')
        );
        
        // Add Chat Transcripts submenu
        add_submenu_page(
            'anam-avatar',
            'Chat Transcripts',
            'Chat Transcripts',
            'manage_options',
            'anam-sessions',
            'anam_render_sessions_page'
        );
        
        // Add Database Integration submenu
        add_submenu_page(
            'anam-avatar',
            'Database Integration',
            'Database Integration',
            'manage_options',
            'anam-supabase-config',
            array($this, 'supabase_config_page')
        );
    }
    
    /**
     * Getting Started page
     */
    public function getting_started_page() {
        ?>
        <div class="wrap">
            <h1>üöÄ Getting Started with Anam Avatar</h1>
            
            <div class="notice notice-info">
                <p><strong>Welcome!</strong> This guide will help you set up your Anam.ai avatar integration.</p>
            </div>
            
            <div style="max-width: 800px; margin-top: 30px;">
                <h2>Quick Setup Steps</h2>
                
                <div style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
                    <h3>1Ô∏è‚É£ Avatar Setup</h3>
                    <p>Set up your Anam.ai API credentials and avatar settings.</p>
                    <a href="<?php echo admin_url('admin.php?page=anam-settings'); ?>" class="button button-primary">Go to Avatar Setup ‚Üí</a>
                </div>
                
                <div style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
                    <h3>2Ô∏è‚É£ Display Settings</h3>
                    <p>Configure how and where your avatar appears on your website.</p>
                    <a href="<?php echo admin_url('admin.php?page=anam-display-settings'); ?>" class="button button-primary">Configure Display ‚Üí</a>
                </div>
                
                <div style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
                    <h3>3Ô∏è‚É£ Chat Transcripts</h3>
                    <p>View and manage conversation transcripts from your avatar.</p>
                    <a href="<?php echo admin_url('admin.php?page=anam-sessions'); ?>" class="button button-primary">View Transcripts ‚Üí</a>
                </div>
                
                <div style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
                    <h3>4Ô∏è‚É£ Database Integration</h3>
                    <p>Configure Supabase database connection for storing conversation data.</p>
                    <a href="<?php echo admin_url('admin.php?page=anam-supabase-config'); ?>" class="button button-primary">Configure Database ‚Üí</a>
                </div>
            </div>
        </div>
        <?php
    }
    
    public function init_settings() {
        register_setting($this->option_group, $this->option_name, array($this, 'sanitize_settings'));
        
        // Avatar Configuration Tab
        add_settings_section(
            'anam_api_section',
            'Anam.ai API Configuration',
            array($this, 'api_section_callback'),
            'anam-settings-avatar'
        );
        
        add_settings_section(
            'anam_avatar_section',
            'Avatar Configuration',
            array($this, 'avatar_section_callback'),
            'anam-settings-avatar'
        );
        
        // Display Settings Tab
        add_settings_section(
            'anam_display_section',
            'Display Settings',
            array($this, 'display_section_callback'),
            'anam-settings-display'
        );
        
        // Supabase Configuration Tab
        add_settings_section(
            'anam_supabase_section',
            'Supabase Integration',
            array($this, 'supabase_section_callback'),
            'anam-settings-supabase'
        );
        
        // API Settings
        add_settings_field(
            'api_key',
            'API Key',
            array($this, 'api_key_field'),
            'anam-settings-avatar',
            'anam_api_section'
        );
        
        add_settings_field(
            'auth_token',
            'Auth Token',
            array($this, 'auth_token_field'),
            'anam-settings-avatar',
            'anam_api_section'
        );
        
        // Avatar Settings
        add_settings_field(
            'persona_id',
            'Persona ID',
            array($this, 'persona_id_field'),
            'anam-settings-avatar',
            'anam_avatar_section'
        );
        
        add_settings_field(
            'avatar_id',
            'Avatar ID',
            array($this, 'avatar_id_field'),
            'anam-settings-avatar',
            'anam_avatar_section'
        );
        
        add_settings_field(
            'voice_id',
            'Voice ID',
            array($this, 'voice_id_field'),
            'anam-settings-avatar',
            'anam_avatar_section'
        );
        
        add_settings_field(
            'llm_id',
            'LLM ID',
            array($this, 'llm_id_field'),
            'anam-settings-avatar',
            'anam_avatar_section'
        );
        
        add_settings_field(
            'system_prompt',
            'System Prompt',
            array($this, 'system_prompt_field'),
            'anam-settings',
            'anam_avatar_section'
        );
        
        // Display Settings
        add_settings_field(
            'display_method',
            'Display Method',
            array($this, 'display_method_field'),
            'anam-settings-display',
            'anam_display_section'
        );
        
        add_settings_field(
            'container_id',
            'Element ID',
            array($this, 'container_id_field'),
            'anam-settings-display',
            'anam_display_section'
        );
        
        add_settings_field(
            'avatar_position',
            'Avatar Position',
            array($this, 'avatar_position_field'),
            'anam-settings-display',
            'anam_display_section'
        );
        
        add_settings_field(
            'page_selection',
            'Show Avatar On',
            array($this, 'page_selection_field'),
            'anam-settings-display',
            'anam_display_section'
        );
        
        // Supabase Settings
        add_settings_field(
            'supabase_enabled',
            'Enable Supabase Integration',
            array($this, 'supabase_enabled_field'),
            'anam-settings-supabase',
            'anam_supabase_section'
        );
        
        add_settings_field(
            'parser_endpoint_url',
            'Parser Endpoint URL',
            array($this, 'parser_endpoint_url_field'),
            'anam-settings-supabase',
            'anam_supabase_section'
        );
        
    }
    
    public function admin_page() {
        $options = get_option($this->option_name, array());
        ?>
        <div class="wrap">
            <h1>ü§ñ Avatar Setup</h1>
            
            <div class="notice notice-info">
                <p><strong>Getting Started:</strong> Configure your Anam.ai credentials below. You can find these values in your <a href="https://app.anam.ai" target="_blank">Anam.ai dashboard</a>.</p>
            </div>
            
            <?php if (isset($_GET['settings-updated']) && $_GET['settings-updated']): ?>
                <div class="notice notice-success is-dismissible">
                    <p>Settings saved successfully! üéâ</p>
                </div>
            <?php endif; ?>
            
            <form method="post" action="options.php" id="anam-settings-form">
                <?php
                settings_fields($this->option_group);
                do_settings_sections('anam-settings-avatar');
                submit_button('Save Settings', 'primary', 'submit', true, array('id' => 'anam-save-settings'));
                ?>
                <button type="button" id="anam-reset-button" class="button button-secondary" style="background: #dc3545; color: white; border-color: #dc3545;">
                    üîÑ Reset Plugin
                </button>
            </form>
            
            <script>
            jQuery(document).ready(function($) {
                $('#anam-reset-button').on('click', function(e) {
                    e.preventDefault();
                    
                    if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL plugin settings and transcripts. This action cannot be undone.\n\nAre you absolutely sure you want to reset the plugin?')) {
                        return;
                    }
                    
                    var $button = $(this);
                    $button.prop('disabled', true).text('üîÑ Resetting...');
                    
                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: {
                            action: 'anam_reset_plugin',
                            nonce: '<?php echo wp_create_nonce('anam_session'); ?>'
                        },
                        success: function(response) {
                            if (response.success) {
                                alert('‚úÖ ' + response.data.message);
                                window.location.href = response.data.redirect;
                            } else {
                                alert('‚ùå Error: ' + response.data);
                                $button.prop('disabled', false).html('üîÑ Reset Plugin');
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('‚ùå Reset failed: ' + error);
                            $button.prop('disabled', false).html('üîÑ Reset Plugin');
                        }
                    });
                });
            });
            </script>
            
            <!-- Auto-verification Modal -->
            <div id="anam-verification-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999999; justify-content: center; align-items: center;">
                <div style="background: white; padding: 40px; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div class="anam-spinner" style="margin: 0 auto 20px; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0073aa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <h2 style="margin: 0 0 10px 0; color: #23282d;">Verifying Your Anam API Key</h2>
                    <p style="margin: 0; color: #666;">Please wait...</p>
                </div>
            </div>
            
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
            
            <div class="anam-help-section" style="margin-top: 30px; padding: 20px; background: #fff; border: 1px solid #ddd; border-radius: 5px; max-width: 978px;">
                <h3>üìö Help & Documentation</h3>
                <ul>
                    <li><strong>API Key:</strong> Found in your Anam.ai dashboard under API settings</li>
                    <li><strong>Persona ID:</strong> The unique identifier for your AI persona</li>
                    <li><strong>Avatar ID:</strong> The visual representation of your avatar</li>
                    <li><strong>Voice ID:</strong> The voice model for your avatar</li>
                    <li><strong>LLM ID:</strong> The language model powering your avatar</li>
                </ul>
                <p style="margin-bottom: 15px;"><a href="https://docs.anam.ai" target="_blank">View Anam.ai documentation</a></p>
                <ul>
                    <li><strong>Container ID:</strong> HTML element ID where avatar should appear (optional)</li>
                </ul>
            </div>
            
            <script>
            jQuery(document).ready(function($) {
                $('#anam-reset-button').on('click', function(e) {
                    e.preventDefault();
                    
                    if (!confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL plugin settings and transcripts. This action cannot be undone.\n\nAre you absolutely sure you want to reset the plugin?')) {
                        return;
                    }
                    
                    var $button = $(this);
                    $button.prop('disabled', true).text('üîÑ Resetting...');
                    
                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: {
                            action: 'anam_reset_plugin',
                            nonce: '<?php echo wp_create_nonce('anam_session'); ?>'
                        },
                        success: function(response) {
                            if (response.success) {
                                alert('‚úÖ ' + response.data.message);
                                window.location.href = response.data.redirect;
                            } else {
                                alert('‚ùå Error: ' + response.data);
                                $button.prop('disabled', false).html('üîÑ Reset Plugin');
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('‚ùå Reset failed: ' + error);
                            $button.prop('disabled', false).html('üîÑ Reset Plugin');
                        }
                    });
                });
            });
            </script>
        </div>
        <?php
    }
    
    public function display_settings_page() {
        $options = get_option($this->option_name, array());
        ?>
        <div class="wrap">
            <h1>üì∫ Display Settings</h1>
            
            <div class="notice notice-info">
                <p><strong>Configure how and where your avatar appears</strong> on your website.</p>
            </div>
            
            <?php if (isset($_GET['settings-updated']) && $_GET['settings-updated']): ?>
                <div class="notice notice-success is-dismissible">
                    <p>Display settings saved successfully! üéâ</p>
                </div>
            <?php endif; ?>
            
            <form method="post" action="options.php" id="anam-display-form">
                <?php
                settings_fields($this->option_group);
                do_settings_sections('anam-settings-display');
                submit_button('Save Display Settings');
                ?>
            </form>
        </div>
        <?php
    }
    
    public function supabase_config_page() {
        $options = get_option($this->option_name, array());
        ?>
        <div class="wrap">
            <h1>üóÑÔ∏è Database Integration</h1>
            
            <div class="notice notice-info">
                <p><strong>Configure your parser endpoint</strong> - This tool handles AI parsing and database storage automatically. <a href="?page=anam-sessions">View Sessions ‚Üí</a></p>
            </div>
            
            <?php if (isset($_GET['settings-updated']) && $_GET['settings-updated']): ?>
                <div class="notice notice-success is-dismissible">
                    <p>Supabase settings saved successfully! üéâ</p>
                </div>
            <?php endif; ?>
            
            <form method="post" action="options.php" id="anam-supabase-form">
                <?php
                settings_fields($this->option_group);
                do_settings_sections('anam-settings-supabase');
                submit_button('Save Database Settings', 'primary', 'submit', true, array('id' => 'anam-supabase-submit'));
                ?>
            </form>
        </div>
        <?php
    }
    
    public function api_section_callback() {
        echo '<p>Enter your Anam.ai API credentials. These are required for the avatar to function.</p>';
    }
    
    public function avatar_section_callback() {
        echo '<p>Configure your avatar\'s appearance, voice, and behavior.</p>';
    }
    
    public function display_section_callback() {
        echo '<p>Control where and how your avatar appears on your website.</p>';
    }
    
    public function supabase_section_callback() {
        echo '<p>Configure your parser endpoint URL. The parser handles AI analysis and database storage automatically. <a href="?page=anam-sessions">View Sessions ‚Üí</a></p>';
    }
    
    public function api_key_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['api_key']) ? $options['api_key'] : '';
        
        echo '<input type="password" id="anam-api-key" name="' . $this->option_name . '[api_key]" value="' . esc_attr($value) . '" class="large-text" placeholder="Enter your Anam.ai API key" />';
        echo '<p class="description">Your Anam.ai API key (base64 encoded Bearer token).</p>';
    }
    
    public function auth_token_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['auth_token']) ? $options['auth_token'] : '';
        
        echo '<input type="password" id="anam-auth-token" name="' . $this->option_name . '[auth_token]" value="' . esc_attr($value) . '" class="large-text" placeholder="Enter your Anam.ai Auth Token" />';
        echo '<p class="description">Your authentication token for API management operations (listing sessions, etc.). This is the base64-encoded Bearer token.</p>';
    }
    
    public function persona_id_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['persona_id']) ? $options['persona_id'] : '';
        echo '<input type="text" name="' . $this->option_name . '[persona_id]" value="' . esc_attr($value) . '" class="regular-text anam-dependent-field" placeholder="e.g., 1bf11606-16b7-4788-a3db-3293148ca7bd" />';
        echo '<p class="description">Unique identifier for your AI persona</p>';
    }
    
    public function avatar_id_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['avatar_id']) ? $options['avatar_id'] : '';
        echo '<input type="text" name="' . $this->option_name . '[avatar_id]" value="' . esc_attr($value) . '" class="regular-text anam-dependent-field" placeholder="e.g., 30fa96d0-26c4-4e55-94a0-517025942e18" />';
        echo '<p class="description">Visual representation ID for your avatar</p>';
    }
    
    public function voice_id_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['voice_id']) ? $options['voice_id'] : '';
        echo '<input type="text" name="' . $this->option_name . '[voice_id]" value="' . esc_attr($value) . '" class="regular-text anam-dependent-field" placeholder="e.g., b7bf471f-5435-49f8-a979-4483e4ccc10f" />';
        echo '<p class="description">Voice model ID for your avatar</p>';
    }
    
    public function llm_id_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['llm_id']) ? $options['llm_id'] : '';
        
        // Determine if we should show custom input
        $is_custom = !in_array($value, ['', '0934d97d-0c3a-4f33-91b0-5e136a0ef466', 'ANAM_LLAMA_v3_3_70B_V1', 'CUSTOMER_CLIENT_V1']);
        $dropdown_value = $is_custom ? 'custom' : $value;
        
        ?>
        <select name="<?php echo $this->option_name; ?>[llm_id]" id="anam-llm-dropdown" class="regular-text anam-dependent-field">
            <option value="" <?php selected($dropdown_value, ''); ?>>Default (Safest if unsure)</option>
            <option value="0934d97d-0c3a-4f33-91b0-5e136a0ef466" <?php selected($dropdown_value, '0934d97d-0c3a-4f33-91b0-5e136a0ef466'); ?>>Standard Anam LLM</option>
            <option value="ANAM_LLAMA_v3_3_70B_V1" <?php selected($dropdown_value, 'ANAM_LLAMA_v3_3_70B_V1'); ?>>Llama 3.3 70B</option>
            <option value="CUSTOMER_CLIENT_V1" <?php selected($dropdown_value, 'CUSTOMER_CLIENT_V1'); ?>>Custom Client Model</option>
            <option value="custom" <?php selected($dropdown_value, 'custom'); ?>>Custom LLM ID</option>
        </select>
        
        <button type="button" id="llm-help-btn" class="button button-link" style="margin-left: 10px;">
            ‚ùì What's this?
        </button>
        
        <div id="custom-llm-input" style="margin-top: 10px; <?php echo $is_custom ? '' : 'display: none;'; ?>">
            <input type="text" id="custom-llm-id" value="<?php echo $is_custom ? esc_attr($value) : ''; ?>" 
                   class="regular-text" placeholder="Enter custom LLM UUID" />
            <p class="description">Enter your custom LLM ID (UUID format)</p>
        </div>
        
        <p class="description">Language model powering your avatar. Most personas work with the default setting.</p>
        
        <!-- LLM Help Modal -->
        <div id="llm-help-modal" style="display: none; position: fixed; z-index: 100000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div style="background-color: #fff; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 600px; position: relative;">
                <span id="llm-modal-close" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                
                <h3 style="margin-top: 0;">LLM (Language Model) Options</h3>
                
                <div style="margin-bottom: 20px;">
                    <h4>Available Options:</h4>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-left: 4px solid #46b450;">
                        <strong>Default (Safest if unsure)</strong><br>
                        <em>Recommended for most users</em><br>
                        Most Anam.ai personas have a default LLM configured. This is the safest choice if you're unsure.
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-left: 4px solid #0073aa;">
                        <strong>Standard Anam LLM</strong><br>
                        <code>0934d97d-0c3a-4f33-91b0-5e136a0ef466</code><br>
                        General purpose language model optimized for conversational AI.
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-left: 4px solid #d63638;">
                        <strong>Llama 3.3 70B</strong><br>
                        <code>ANAM_LLAMA_v3_3_70B_V1</code><br>
                        Advanced open-source model with 70 billion parameters. More capable but may be slower.
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-left: 4px solid #dba617;">
                        <strong>Custom Client Model</strong><br>
                        <code>CUSTOMER_CLIENT_V1</code><br>
                        For custom LLM integrations and specialized use cases.
                    </div>
                    
                    <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-left: 4px solid #72777c;">
                        <strong>Custom LLM ID</strong><br>
                        Enter your own LLM UUID if you have a custom model configured in your Anam.ai account.
                    </div>
                </div>
                
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <strong>üí° Pro Tip:</strong> Start with "Default (Safest if unsure)" - it works for most personas. Only change if your specific persona requires a different LLM.
                </div>
                
                <div style="text-align: right;">
                    <button type="button" id="llm-modal-ok" class="button button-primary">Got it!</button>
                </div>
            </div>
        </div>
        <?php
    }
    
    public function system_prompt_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['system_prompt']) ? $options['system_prompt'] : 'You are a helpful digital assistant. Be friendly and concise in your responses.';
        echo '<textarea name="' . $this->option_name . '[system_prompt]" rows="12" class="large-text anam-dependent-field" style="width: 100%; max-width: 978px; resize: vertical;" placeholder="Enter system prompt for your avatar...">' . esc_textarea($value) . '</textarea>';
        echo '<p class="description">Define how your avatar should behave and respond to users.</p>';
    }
    
    public function display_method_field() {
        $options = get_option($this->option_name, array());
        
        // Handle backward compatibility
        $display_method = 'element_id'; // Default as requested
        if (isset($options['display_method'])) {
            $display_method = $options['display_method'];
        } else {
            // Migrate from old settings
            if (isset($options['avatar_position']) && $options['avatar_position'] === 'custom') {
                $display_method = 'element_id';
            } else if (isset($options['avatar_position']) || isset($options['target_pages'])) {
                $display_method = 'page_position';
            }
        }
        ?>
        <div id="display-method-radios">
            <label style="display: block; margin-bottom: 10px;">
                <input type="radio" name="<?php echo $this->option_name; ?>[display_method]" value="element_id" <?php checked($display_method, 'element_id'); ?> />
                <strong>By Element ID</strong> - Stream avatar to a specific HTML element on your pages
            </label>
            <label style="display: block;">
                <input type="radio" name="<?php echo $this->option_name; ?>[display_method]" value="page_position" <?php checked($display_method, 'page_position'); ?> />
                <strong>By Page and Position</strong> - Show avatar at fixed position on selected pages
            </label>
        </div>
        <p class="description">Choose how you want to display the avatar on your website</p>
        <?php
    }
    
    public function container_id_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['container_id']) ? $options['container_id'] : '';
        
        echo '<div id="element-id-section">';
        echo '<input type="text" id="anam-container-id" name="' . $this->option_name . '[container_id]" value="' . esc_attr($value) . '" class="regular-text" placeholder="element-id" />';
        echo '<p class="description">HTML element ID where the avatar should appear (e.g., "anam-stream-container")</p>';
        echo '</div>';
    }
    
    public function avatar_position_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['avatar_position']) ? $options['avatar_position'] : 'bottom-right';
        ?>
        <div id="page-position-section">
            <select name="<?php echo $this->option_name; ?>[avatar_position]" id="anam-avatar-position">
                <option value="bottom-right" <?php selected($value, 'bottom-right'); ?>>Bottom Right</option>
                <option value="bottom-left" <?php selected($value, 'bottom-left'); ?>>Bottom Left</option>
                <option value="top-right" <?php selected($value, 'top-right'); ?>>Top Right</option>
                <option value="top-left" <?php selected($value, 'top-left'); ?>>Top Left</option>
            </select>
            <p class="description">Choose where the avatar appears on your site</p>
        </div>
        <?php
    }
    
    public function supabase_enabled_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['supabase_enabled']) ? $options['supabase_enabled'] : false;
        echo '<label><input type="checkbox" id="supabase-enable" name="' . $this->option_name . '[supabase_enabled]" value="1" ' . checked($value, true, false) . ' /> Enable Supabase integration</label>';
        echo '<p class="description">Turn on to store parsed vehicle data in Supabase</p>';
    }
    
    public function parser_endpoint_url_field() {
        $options = get_option($this->option_name, array());
        $value = isset($options['parser_endpoint_url']) ? $options['parser_endpoint_url'] : 'https://iegsoumvmhvvhmdyxhxs.supabase.co/functions/v1/key-value-processor';
        echo '<input type="url" name="' . $this->option_name . '[parser_endpoint_url]" value="' . esc_attr($value) . '" class="large-text" placeholder="https://your-parser-endpoint.com" />';
        echo '<p class="description">The URL of your parser endpoint. This tool handles AI parsing and database storage internally.</p>';
    }
    
    public function page_selection_field() {
        $options = get_option($this->option_name, array());
        $selected_pages = isset($options['selected_pages']) ? $options['selected_pages'] : array('homepage');
        
        if (!is_array($selected_pages)) {
            $selected_pages = array('homepage'); // Default to homepage selected
        }
        
        echo '<div id="page-selection-section">';
        echo '<div style="border: 1px solid #ddd; padding: 15px; background: #f9f9f9;">';
        
        // Quick categories
        echo '<h4 style="margin-top: 0;">Quick Options:</h4>';
        echo '<label style="display: block; margin-bottom: 8px;"><input type="checkbox" name="' . $this->option_name . '[selected_pages][]" value="all_posts" ' . (in_array('all_posts', $selected_pages) ? 'checked' : '') . ' /> <strong>All Posts</strong></label>';
        echo '<label style="display: block; margin-bottom: 15px;"><input type="checkbox" name="' . $this->option_name . '[selected_pages][]" value="all_pages" ' . (in_array('all_pages', $selected_pages) ? 'checked' : '') . ' /> <strong>All Pages</strong></label>';
        
        // Individual pages
        echo '<h4>Individual Pages:</h4>';
        
        // Home page first (always show, selected by default)
        $homepage_checked = in_array('homepage', $selected_pages) ? 'checked' : '';
        echo '<label id="homepage-checkbox" style="display: block; margin-bottom: 5px;"><input type="checkbox" name="' . $this->option_name . '[selected_pages][]" value="homepage" ' . $homepage_checked . ' /> <strong>Home</strong></label>';
        
        // Get all pages and sort alphabetically, excluding homepage
        $homepage_id = get_option('page_on_front');
        $pages = get_pages(array('number' => 50, 'sort_column' => 'post_title', 'sort_order' => 'ASC'));
        if (!empty($pages)) {
            foreach ($pages as $page) {
                // Skip the homepage if it's set as a static page (we already show "Home" above)
                if ($homepage_id && $page->ID == $homepage_id) {
                    continue;
                }
                
                $page_value = 'page_' . $page->ID;
                $checked = in_array($page_value, $selected_pages) ? 'checked' : '';
                echo '<label class="individual-page-checkbox" style="display: block; margin-bottom: 5px;"><input type="checkbox" name="' . $this->option_name . '[selected_pages][]" value="' . $page_value . '" ' . $checked . ' /> ' . esc_html($page->post_title) . '</label>';
            }
        }
        
        // Individual posts
        $posts = get_posts(array('numberposts' => 20, 'post_status' => 'publish'));
        if (!empty($posts)) {
            echo '<h4 style="margin-top: 15px;">Recent Posts:</h4>';
            foreach ($posts as $post) {
                $post_value = 'post_' . $post->ID;
                $checked = in_array($post_value, $selected_pages) ? 'checked' : '';
                echo '<label class="individual-post-checkbox" style="display: block; margin-bottom: 5px;"><input type="checkbox" name="' . $this->option_name . '[selected_pages][]" value="' . $post_value . '" ' . $checked . ' /> ' . esc_html($post->post_title) . '</label>';
            }
        }
        
        echo '</div>';
        echo '<p class="description">Select where you want the avatar to appear. Homepage is selected by default.</p>';
        echo '</div>';
    }
    
    
    public function sanitize_settings($input) {
        // Start with existing saved options to preserve data from other pages
        $existing_options = get_option($this->option_name, array());
        $sanitized = $existing_options;
        
        if (isset($input['api_key'])) {
            // Don't sanitize API key - it contains special characters like colons and equals
            $sanitized['api_key'] = trim($input['api_key']);
        }
        
        if (isset($input['auth_token'])) {
            // Don't sanitize auth token - it's base64 encoded and contains special characters
            $sanitized['auth_token'] = trim($input['auth_token']);
        }
        
        // Check if ANY critical config values changed - if so, clear all transcripts
        $config_changed = false;
        $critical_fields = array('api_key', 'auth_token', 'persona_id', 'avatar_id', 'voice_id', 'llm_id');
        
        foreach ($critical_fields as $field) {
            if (isset($input[$field])) {
                $old_value = isset($existing_options[$field]) ? $existing_options[$field] : '';
                $new_value = $field === 'persona_id' ? sanitize_text_field($input[$field]) : $input[$field];
                
                if ($old_value !== $new_value) {
                    $config_changed = true;
                    error_log("üîÑ Config changed: {$field} changed from '{$old_value}' to '{$new_value}'");
                    break;
                }
            }
        }
        
        if (isset($input['persona_id'])) {
            $sanitized['persona_id'] = sanitize_text_field($input['persona_id']);
            error_log('üíæ SAVING persona_id to database: ' . $sanitized['persona_id']);
        } else {
            error_log('‚ö†Ô∏è WARNING: persona_id NOT in input array during save!');
        }
        
        if (isset($input['avatar_id'])) {
            $sanitized['avatar_id'] = sanitize_text_field($input['avatar_id']);
        }
        
        if (isset($input['voice_id'])) {
            $sanitized['voice_id'] = sanitize_text_field($input['voice_id']);
        }
        
        if (isset($input['llm_id'])) {
            $llm_value = sanitize_text_field($input['llm_id']);
            // Handle custom LLM ID case
            if ($llm_value === 'custom' && isset($_POST['custom_llm_id'])) {
                $sanitized['llm_id'] = sanitize_text_field($_POST['custom_llm_id']);
            } else {
                $sanitized['llm_id'] = $llm_value;
            }
        }
        
        if (isset($input['system_prompt'])) {
            $sanitized['system_prompt'] = sanitize_textarea_field($input['system_prompt']);
        }
        
        // Display Method
        if (isset($input['display_method'])) {
            $sanitized['display_method'] = sanitize_text_field($input['display_method']);
        }
        
        // Container ID - only save if display method is element_id
        if (isset($input['container_id'])) {
            if (isset($input['display_method']) && $input['display_method'] === 'element_id') {
                $sanitized['container_id'] = sanitize_text_field($input['container_id']);
            } else {
                $sanitized['container_id'] = ''; // Clear container ID for page_position method
            }
        }
        
        // Avatar Position - only save if display method is page_position
        if (isset($input['avatar_position'])) {
            if (isset($input['display_method']) && $input['display_method'] === 'page_position') {
                $sanitized['avatar_position'] = sanitize_text_field($input['avatar_position']);
            } else {
                $sanitized['avatar_position'] = 'bottom-right'; // Default position
            }
        }
        
        // Selected Pages - only save if display method is page_position
        if (isset($input['selected_pages']) && is_array($input['selected_pages'])) {
            if (isset($input['display_method']) && $input['display_method'] === 'page_position') {
                $sanitized['selected_pages'] = array_map('sanitize_text_field', $input['selected_pages']);
            } else {
                $sanitized['selected_pages'] = array(); // Clear selected pages for element_id method
            }
        } else {
            $sanitized['selected_pages'] = array();
        }
        
        // Legacy fields for backward compatibility (will be migrated)
        if (isset($input['target_pages'])) {
            $sanitized['target_pages'] = sanitize_text_field($input['target_pages']);
        }
        
        if (isset($input['custom_slugs'])) {
            $sanitized['custom_slugs'] = sanitize_text_field($input['custom_slugs']);
        }
        
        // Supabase settings
        $sanitized['supabase_enabled'] = isset($input['supabase_enabled']) ? true : false;
        
        if (isset($input['supabase_url'])) {
            $sanitized['supabase_url'] = esc_url_raw($input['supabase_url']);
        }
        
        if (isset($input['supabase_key'])) {
            $sanitized['supabase_key'] = sanitize_text_field($input['supabase_key']);
        }
        
        if (isset($input['supabase_table'])) {
            $sanitized['supabase_table'] = sanitize_text_field($input['supabase_table']);
        }
        
        // Email notifications
        $sanitized['email_notifications'] = isset($input['email_notifications']) ? true : false;
        
        // Advanced SDK functionality
        $sanitized['advanced_sdk_enabled'] = isset($input['advanced_sdk_enabled']) ? true : false;
        
        // If ANY critical config changed, clear ALL transcripts from WordPress database
        if ($config_changed) {
            global $wpdb;
            $table_name = $wpdb->prefix . 'anam_transcripts';
            $deleted = $wpdb->query("TRUNCATE TABLE {$table_name}");
            error_log("üóëÔ∏è CONFIG CHANGED - Cleared all transcripts from database. Fresh start with new config!");
            
            // Set a transient to show admin notice
            set_transient('anam_config_changed_notice', true, 45);
        }
        
        return $sanitized;
    }
    
    /**
     * Show admin notice when config changes and transcripts are cleared
     */
    public function show_config_changed_notice() {
        if (get_transient('anam_config_changed_notice')) {
            ?>
            <div class="notice notice-success is-dismissible">
                <p><strong>‚úÖ Configuration Updated!</strong> All previous transcripts have been cleared. Only new sessions with the updated configuration will be displayed.</p>
            </div>
            <?php
            delete_transient('anam_config_changed_notice');
        }
        
        if (get_transient('anam_reset_notice')) {
            ?>
            <div class="notice notice-success is-dismissible">
                <p><strong>üîÑ Plugin Reset Complete!</strong> All settings and transcripts have been cleared. The plugin is now in its default state.</p>
            </div>
            <?php
            delete_transient('anam_reset_notice');
        }
    }
    
    public function enqueue_admin_scripts($hook) {
        // Debug: Log the hook to see what it actually is
        error_log('Admin hook: ' . $hook);
        
        // Enqueue on ALL admin pages for now to test
        if (strpos($hook, 'anam') !== false || $hook === 'anam-avatar_page_anam-settings' || $hook === 'settings_page_anam-settings') {
            error_log('‚úÖ Enqueuing admin.js on hook: ' . $hook);
            
            wp_enqueue_script('anam-admin', plugin_dir_url(__FILE__) . 'assets/js/admin.js', array('jquery'), '2.0.3', true);
            
            // Pass both anam_ajax (for verification) and ANAM_CONFIG (for sessions)
            wp_localize_script('anam-admin', 'anam_ajax', array(
                'ajax_url' => admin_url('admin-ajax.php'),
                'nonce' => wp_create_nonce('anam_verify_api'),
                'admin_nonce' => wp_create_nonce('anam_admin_nonce')
            ));
            
            wp_localize_script('anam-admin', 'ANAM_CONFIG', array(
                'ajaxUrl' => admin_url('admin-ajax.php'),
                'nonce' => wp_create_nonce('anam_session')
            ));
            
            error_log('‚úÖ Localized ANAM_CONFIG with ajaxUrl and nonce');
        } else {
            error_log('‚ùå Hook does not match anam pattern: ' . $hook);
        }
        
        // Enqueue on Getting Started page
        if ($hook === 'toplevel_page_anam-avatar') {
            wp_enqueue_script('anam-getting-started', plugin_dir_url(__FILE__) . 'anam-getting-started.js', array('jquery'), '1.0.5', true);
            wp_localize_script('anam-getting-started', 'anam_ajax', array(
                'ajax_url' => admin_url('admin-ajax.php'),
                'admin_nonce' => wp_create_nonce('anam_admin_nonce')
            ));
        }
    }
    
    public function add_avatar_integration() {
        if (!$this->should_show_avatar()) {
            return;
        }
        
        $options = get_option($this->option_name, array());
        
        // Debug logging
        error_log('üéØ Avatar Integration Check:');
        error_log('Options retrieved: ' . print_r($options, true));
        error_log('API Key present: ' . (empty($options['api_key']) ? 'NO' : 'YES'));
        error_log('Persona ID present: ' . (empty($options['persona_id']) ? 'NO' : 'YES'));
        
        // Check if we have minimum required settings
        if (empty($options['api_key']) || empty($options['persona_id'])) {
            error_log('‚ùå Avatar NOT loading - missing required config');
            return;
        }
        
        error_log('‚úÖ Avatar SHOULD load - config is present');
        
        $display_method = isset($options['display_method']) ? $options['display_method'] : 'element_id';
        $container_id = !empty($options['container_id']) ? $options['container_id'] : 'anam-stream-container';
        $position = isset($options['avatar_position']) ? $options['avatar_position'] : 'bottom-right';
        
        ?>
        <!-- Anam Avatar Integration -->
        <?php if ($display_method === 'page_position'): ?>
        <div id="anam-avatar-widget" style="position: fixed; <?php echo $this->get_position_styles($position); ?>; z-index: 9999; width: 300px; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); overflow: hidden;">
            <div style="padding: 20px; text-align: center; position: relative;">
                <div style="font-size: 32px; margin-bottom: 15px;">üí¨</div>
                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">Ready to chat?</h3>
                <p style="margin: 0 0 20px 0; color: #666; font-size: 14px; line-height: 1.4;">
                    Start a conversation with our AI assistant
                </p>
                <button id="anam-start-btn" style="padding: 12px 24px; border: none; background: #007cba; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    Start Conversation
                </button>
            </div>
        </div>
        <?php endif; ?>


        <?php
        // Enqueue frontend JavaScript module
        wp_enqueue_script(
            'anam-frontend',
            plugin_dir_url(__FILE__) . 'assets/js/frontend.js',
            array(),
            '1.0.0',
            true
        );
        
        // Add module type attribute
        add_filter('script_loader_tag', function($tag, $handle) {
            if ('anam-frontend' === $handle) {
                $tag = str_replace('<script ', '<script type="module" ', $tag);
            }
            return $tag;
        }, 10, 2);
        
        // Pass configuration to frontend
        wp_localize_script('anam-frontend', 'ANAM_FRONTEND_CONFIG', array(
            'ajaxUrl' => admin_url('admin-ajax.php'),
            'nonce' => wp_create_nonce('anam_session'),
            'displayMethod' => esc_js($display_method),
            'containerId' => esc_js($container_id),
            'position' => esc_js($position)
        ));
        ?>
        <?php
    }
    
    private function get_position_styles($position) {
        switch($position) {
            case 'top-left': return 'top: 20px; left: 20px';
            case 'top-right': return 'top: 20px; right: 20px';
            case 'bottom-left': return 'bottom: 20px; left: 20px';
            case 'bottom-right': 
            default: return 'bottom: 20px; right: 20px';
        }
    }
    
    private function should_show_avatar() {
        $options = get_option($this->option_name, array());
        $display_method = isset($options['display_method']) ? $options['display_method'] : 'element_id';
        
        // For element_id method, avatar only shows where container exists (handled by JavaScript)
        if ($display_method === 'element_id') {
            return true; // Let JavaScript handle container detection
        }
        
        // For page_position method, check selected pages
        if ($display_method === 'page_position') {
            $selected_pages = isset($options['selected_pages']) ? $options['selected_pages'] : array('homepage');
            
            if (!is_array($selected_pages) || empty($selected_pages)) {
                return false;
            }
            
            // Check quick options (homepage is now handled as individual page selection)
            // Note: 'homepage' may still exist in old settings for backward compatibility
            
            if (in_array('all_posts', $selected_pages) && is_single()) {
                return true;
            }
            
            if (in_array('all_pages', $selected_pages) && is_page()) {
                return true;
            }
            
            // Check for legacy homepage selection (backward compatibility)
            if (in_array('homepage', $selected_pages) && is_front_page()) {
                return true;
            }
            
            // Check individual pages and posts
            global $post;
            if ($post) {
                $current_page_value = is_page() ? 'page_' . $post->ID : 'post_' . $post->ID;
                if (in_array($current_page_value, $selected_pages)) {
                    return true;
                }
            }
            
            // Check if current page is homepage and homepage page is selected individually
            if (is_front_page()) {
                $homepage_id = get_option('page_on_front');
                if ($homepage_id && in_array('page_' . $homepage_id, $selected_pages)) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Fallback for backward compatibility with old target_pages system
        $target_pages = isset($options['target_pages']) ? $options['target_pages'] : 'all';
        
        switch($target_pages) {
            case 'home':
                return is_front_page();
            case 'posts':
                return is_single();
            case 'pages':
                return is_page();
            case 'custom':
                if (!empty($options['custom_slugs'])) {
                    global $post;
                    if ($post) {
                        $slugs = array_map('trim', explode(',', $options['custom_slugs']));
                        return in_array($post->post_name, $slugs);
                    }
                }
                return false;
            case 'all':
            default:
                return true;
        }
    }
    
    // AJAX handler methods moved to includes/class-ajax-handlers.php
    
    /**
     * Disable page caching for pages with avatar
     */
    public function disable_page_caching() {
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'anam_session')) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        $options = get_option($this->option_name, array());
        
        if (empty($options['api_key'])) {
            wp_send_json_error('API key not configured');
            return;
        }
        
        // Build persona config according to new API requirements
        $persona_config = array();
        
        // Add persona ID if available (this is key for the new API)
        if (!empty($options['persona_id'])) {
            $persona_config['personaId'] = $options['persona_id'];
            error_log('üéØ Creating session with personaId: ' . $options['persona_id']);
        } else {
            error_log('‚ö†Ô∏è WARNING: Creating session WITHOUT personaId - this will cause transcript mismatch!');
        }
        
        // Add other configuration
        if (!empty($options['avatar_id'])) {
            $persona_config['avatarId'] = $options['avatar_id'];
        }
        
        if (!empty($options['voice_id'])) {
            $persona_config['voiceId'] = $options['voice_id'];
        }
        
        if (!empty($options['llm_id'])) {
            $persona_config['llmId'] = $options['llm_id'];
        }
        
        // Always include system prompt
        $persona_config['systemPrompt'] = !empty($options['system_prompt']) 
            ? $options['system_prompt'] 
            : 'You are a helpful digital assistant.';
            
        // Add a name for the persona
        $persona_config['name'] = 'WordPress Avatar';
        
        $request_body = array(
            'personaConfig' => $persona_config
        );
        
        $args = array(
            'method' => 'POST',
            'headers' => array(
                'Content-Type' => 'application/json',
                'Authorization' => 'Bearer ' . $options['api_key']
            ),
            'body' => json_encode($request_body),
            'timeout' => 30,
            'sslverify' => true
        );
        
        $response = wp_remote_post('https://api.anam.ai/v1/auth/session-token', $args);
        
        if (is_wp_error($response)) {
            wp_send_json_error('Connection error: ' . $response->get_error_message());
            return;
        }
        
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);
        
        if ($response_code !== 200) {
            wp_send_json_error("API error {$response_code}: {$response_body}");
            return;
        }
        
        $data = json_decode($response_body, true);
        
        if (isset($data['sessionToken']) && !empty($data['sessionToken'])) {
            wp_send_json_success(array(
                'sessionToken' => $data['sessionToken'],
                'timestamp' => current_time('mysql')
            ));
        } else {
            wp_send_json_error('Session token not found in response');
        }
    }
    
    public function verify_api_key() {
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'anam_verify_api')) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        // Don't sanitize - base64 strings have special characters
        $api_key = isset($_POST['api_key']) ? trim($_POST['api_key']) : '';
        
        if (empty($api_key)) {
            wp_send_json_error('API key is required');
            return;
        }
        
        // Simple API verification - just check personas endpoint
        $args = array(
            'method' => 'GET',
            'headers' => array(
                'Content-Type' => 'application/json',
                'Authorization' => 'Bearer ' . $api_key
            ),
            'timeout' => 15,
            'sslverify' => true
        );
        
        $start_time = microtime(true);
        $response = wp_remote_get('https://api.anam.ai/v1/personas', $args);
        $response_time = round((microtime(true) - $start_time) * 1000);
        
        if (is_wp_error($response)) {
            wp_send_json_error('Connection failed: ' . $response->get_error_message());
            return;
        }
        
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);
        
        // Check if API key is valid based on response
        if ($response_code === 200) {
            // Mark as verified and save timestamp
            update_option('anam_api_verified', true);
            update_option('anam_api_verified_at', current_time('mysql'));
            wp_send_json_success(array(
                'message' => 'API key verified successfully',
                'response_time' => $response_time . 'ms',
                'verified_at' => current_time('mysql')
            ));
        } else {
            // Clear verification status
            update_option('anam_api_verified', false);
            
            // Provide helpful error message
            $error_message = 'API verification failed';
            if ($response_code === 401 || $response_code === 403) {
                $error_message = 'Invalid API key - Access denied';
            } elseif ($response_code === 429) {
                $error_message = 'Rate limit exceeded - Please try again later';
            } elseif ($response_code >= 500) {
                $error_message = 'Anam.ai server error - Please try again later';
            }
            
            wp_send_json_error(array(
                'message' => $error_message,
                'status_code' => $response_code,
                'response' => substr($response_body, 0, 200)
            ));
        }
    }
    
    // Handle advanced SDK toggle
    public function handle_toggle_advanced_sdk() {
        if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'anam_admin_nonce')) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        // Get the enabled value - it comes as string 'true' or 'false'
        $enabled_string = isset($_POST['enabled']) ? $_POST['enabled'] : 'false';
        $enabled = ($enabled_string === 'true');
        
        // Get current options - MUST get fresh copy
        $options = get_option('anam_options', array());
        
        // Set the value
        $options['advanced_sdk_enabled'] = $enabled;
        
        // Delete first to force update
        delete_option('anam_options');
        add_option('anam_options', $options);
        
        wp_send_json_success(array(
            'enabled' => $enabled,
            'message' => $enabled ? 'Advanced SDK enabled' : 'Advanced SDK disabled'
        ));
    }
    
    // Handle session token requests
    public function handle_session_token() {
        // Verify nonce
        if (!wp_verify_nonce($_POST['nonce'], 'anam_session')) {
            wp_send_json_error('Invalid nonce');
        }
        
        $options = get_option($this->option_name, array());
        $api_key = isset($options['api_key']) ? $options['api_key'] : '';
        
        if (empty($api_key)) {
            wp_send_json_error('API key not configured');
        }
        
        // Get persona configuration from options
        $persona_id = isset($options['persona_id']) ? $options['persona_id'] : '';
        $avatar_id = isset($options['avatar_id']) ? $options['avatar_id'] : '';
        $voice_id = isset($options['voice_id']) ? $options['voice_id'] : '';
        $llm_id = isset($options['llm_id']) ? $options['llm_id'] : '';
        $system_prompt = isset($options['system_prompt']) ? $options['system_prompt'] : '';
        
        // Build persona config
        $persona_config = array();
        
        if (!empty($persona_id)) {
            $persona_config['personaId'] = $persona_id;
        }
        
        if (!empty($avatar_id)) {
            $persona_config['avatarId'] = $avatar_id;
        }
        
        if (!empty($voice_id)) {
            $persona_config['voiceId'] = $voice_id;
        }
        
        if (!empty($llm_id)) {
            $persona_config['llmId'] = $llm_id;
        }
        
        if (!empty($system_prompt)) {
            $persona_config['systemPrompt'] = $system_prompt;
        }
        
        // Create session token request
        $response = wp_remote_post('https://api.anam.ai/v1/auth/session-token', array(
            'headers' => array(
                'Content-Type' => 'application/json',
                'Authorization' => 'Bearer ' . $api_key
            ),
            'body' => json_encode(array(
                'personaConfig' => $persona_config
            )),
            'timeout' => 15,
            'sslverify' => true
        ));
        
        if (is_wp_error($response)) {
            wp_send_json_error('Failed to get session token: ' . $response->get_error_message());
        }
        
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);
        
        // Debug logging
        error_log('Anam Session Token Response Code: ' . $response_code);
        error_log('Anam Session Token Response Body: ' . $response_body);
        
        if ($response_code === 200 || $response_code === 201) {
            $data = json_decode($response_body, true);
            
            if (isset($data['sessionToken'])) {
                wp_send_json_success(array(
                    'sessionToken' => $data['sessionToken']
                ));
            } else {
                wp_send_json_error('Invalid response format');
            }
        } else {
            wp_send_json_error('Session token request failed');
        }
    }

    /**
     * AJAX handler to get session data from Anam API
     */
    public function get_session_data() {
        if (!wp_verify_nonce($_POST['nonce'], 'anam_session')) {
            wp_send_json_error('Security check failed');
            return;
        }

        $session_id = sanitize_text_field($_POST['session_id']);
        if (empty($session_id)) {
            wp_send_json_error('No session ID provided');
            return;
        }

        $api_key = get_option('anam_api_key');
        if (empty($api_key)) {
            wp_send_json_error('API key not configured');
            return;
        }

        // Call Anam API to get session data
        $response = wp_remote_get("https://api.anam.ai/v1/sessions/{$session_id}", array(
            'headers' => array(
                'Authorization' => 'Bearer ' . $api_key,
                'Content-Type' => 'application/json'
            ),
            'timeout' => 30
        ));

        if (is_wp_error($response)) {
            wp_send_json_error('API request failed: ' . $response->get_error_message());
            return;
        }

        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);

        if ($response_code === 200) {
            $session_data = json_decode($response_body, true);
            
            // Parse vehicle data from transcript
            $vehicle_data = $this->parse_vehicle_data($session_data);
            
            wp_send_json_success(array(
                'session_data' => $session_data,
                'vehicle_data' => $vehicle_data,
                'transcript' => isset($session_data['transcript']) ? $session_data['transcript'] : 'No transcript available'
            ));
        } else {
            wp_send_json_error('Failed to fetch session data: HTTP ' . $response_code);
        }
    }

    /**
     * Parse vehicle data from session transcript
     */
    private function parse_vehicle_data($session_data) {
        if (!isset($session_data['transcript']) || empty($session_data['transcript'])) {
            return array('error' => 'No transcript data available');
        }

        $transcript = is_array($session_data['transcript']) ? 
            implode(' ', array_column($session_data['transcript'], 'text')) : 
            $session_data['transcript'];

        $vehicle_data = array();

        // VIN pattern (17 characters, alphanumeric)
        if (preg_match('/\b[A-HJ-NPR-Z0-9]{17}\b/i', $transcript, $matches)) {
            $vehicle_data['vin'] = strtoupper($matches[0]);
        }

        // Year pattern (4 digits, 1900-2030)
        if (preg_match('/\b(19|20)\d{2}\b/', $transcript, $matches)) {
            $vehicle_data['year'] = $matches[0];
        }

        // Make pattern (common car manufacturers)
        $makes = array('toyota', 'honda', 'ford', 'chevrolet', 'nissan', 'bmw', 'mercedes', 'audi', 'volkswagen', 'hyundai', 'kia', 'mazda', 'subaru', 'lexus', 'acura', 'infiniti', 'cadillac', 'buick', 'gmc', 'jeep', 'ram', 'dodge', 'chrysler', 'lincoln', 'volvo', 'jaguar', 'land rover', 'porsche', 'tesla', 'mitsubishi');
        foreach ($makes as $make) {
            if (preg_match('/\b' . preg_quote($make, '/') . '\b/i', $transcript)) {
                $vehicle_data['make'] = ucfirst($make);
                break;
            }
        }

        // Model pattern (word after make, if make found)
        if (isset($vehicle_data['make'])) {
            $pattern = '/\b' . preg_quote($vehicle_data['make'], '/') . '\s+([a-z0-9\-]+)/i';
            if (preg_match($pattern, $transcript, $matches)) {
                $vehicle_data['model'] = ucfirst($matches[1]);
            }
        }

        return empty($vehicle_data) ? array('error' => 'No vehicle data found in transcript') : $vehicle_data;
    }

    /**
     * AJAX handler to list sessions from Anam API
     */
    public function list_sessions() {
        // Verify nonce
        if (!check_ajax_referer('anam_session', 'nonce', false)) {
            wp_send_json_error('Security check failed');
            return;
        }

        // Get saved credentials
        $options = get_option('anam_options', array());
        $api_key = isset($options['api_key']) ? $options['api_key'] : '';
        $auth_token = isset($options['auth_token']) ? $options['auth_token'] : '';
        $persona_id = isset($options['persona_id']) ? $options['persona_id'] : '';

        // Debug logging
        error_log('=== LIST SESSIONS DEBUG ===');
        error_log('List Sessions - API Key: ' . (empty($api_key) ? 'EMPTY' : 'Present (length: ' . strlen($api_key) . ')'));
        error_log('List Sessions - Auth Token: ' . (empty($auth_token) ? 'EMPTY' : 'Present (length: ' . strlen($auth_token) . ')'));
        error_log('List Sessions - Persona ID: ' . (empty($persona_id) ? 'EMPTY' : $persona_id));
        error_log('List Sessions - Full options array keys: ' . implode(', ', array_keys($options)));

        // Use api_key for Bearer token (it contains the base64-encoded token)
        // auth_token is the UUID/apiKeyId, NOT the Bearer token
        if (!empty($api_key)) {
            $bearer_token = $api_key;
            error_log('List Sessions - Using api_key for Bearer token');
        } else {
            wp_send_json_error('No API Key configured. Please add your API Key in Avatar Setup.');
            return;
        }

        // Get pagination parameters
        $page = isset($_POST['page']) ? intval($_POST['page']) : 1;
        $per_page = isset($_POST['perPage']) ? intval($_POST['perPage']) : 10;

        // Build API URL - no filters, just pagination
        $api_url = 'https://api.anam.ai/v1/sessions?page=' . $page . '&perPage=' . $per_page;
        
        // TEMPORARILY DISABLED: personaId filter to see ALL sessions
        // if (!empty($persona_id)) {
        //     $api_url .= '&personaId=' . urlencode($persona_id);
        //     error_log('List Sessions - Filtering by personaId: ' . $persona_id);
        // }
        
        error_log('List Sessions - API URL: ' . $api_url);
        error_log('List Sessions - Testing WITHOUT personaId filter to see all sessions');

        // Make request to Anam API
        $response = wp_remote_get($api_url, array(
            'headers' => array(
                'Authorization' => 'Bearer ' . $bearer_token,
                'Content-Type' => 'application/json'
            ),
            'timeout' => 15
        ));

        if (is_wp_error($response)) {
            error_log('List Sessions - WP Error: ' . $response->get_error_message());
            wp_send_json_error('Failed to fetch sessions: ' . $response->get_error_message());
            return;
        }

        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);

        error_log('List Sessions - Status Code: ' . $status_code);
        error_log('List Sessions - Raw Body: ' . substr($body, 0, 500)); // First 500 chars

        if ($status_code !== 200) {
            error_log('List Sessions - Non-200 status, full body: ' . $body);
            wp_send_json_error('API returned error: ' . $status_code . ' - ' . $body);
            return;
        }

        $data = json_decode($body, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            error_log('List Sessions - JSON Error: ' . json_last_error_msg());
            wp_send_json_error('Failed to parse API response: ' . json_last_error_msg());
            return;
        }

        // Debug: Log the parsed response structure
        error_log('List Sessions - Parsed data keys: ' . implode(', ', array_keys($data)));
        if (isset($data['data'])) {
            error_log('List Sessions - Sessions count: ' . count($data['data']));
        }

        wp_send_json_success($data);
    }
    
    /**
     * AJAX handler to get individual session details with transcript
     */
    public function get_session_details() {
        // Verify nonce
        if (!check_ajax_referer('anam_session', 'nonce', false)) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        $session_id = isset($_POST['sessionId']) ? sanitize_text_field($_POST['sessionId']) : '';
        
        if (empty($session_id)) {
            wp_send_json_error('Session ID is required');
            return;
        }
        
        // Get saved transcript from database
        global $wpdb;
        $table_name = $wpdb->prefix . 'anam_transcripts';
        
        $transcript_row = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table_name WHERE session_id = %s",
            $session_id
        ));
        
        $response_data = array(
            'session_id' => $session_id,
            'has_transcript' => false,
            'transcript' => null,
            'message_count' => 0,
            'parsed' => false,
            'parsed_at' => null
        );
        
        if ($transcript_row) {
            error_log('Raw transcript data: ' . substr($transcript_row->transcript_data, 0, 200));
            $transcript_messages = json_decode($transcript_row->transcript_data, true);
            
            if ($transcript_messages === null) {
                error_log('‚ùå JSON decode failed: ' . json_last_error_msg());
                error_log('Raw data length: ' . strlen($transcript_row->transcript_data));
            }
            
            $response_data['has_transcript'] = true;
            $response_data['transcript'] = $transcript_messages;
            $response_data['message_count'] = $transcript_row->message_count;
            $response_data['created_at'] = $transcript_row->created_at;
            $response_data['updated_at'] = $transcript_row->updated_at;
            $response_data['parsed'] = (bool)$transcript_row->parsed;
            $response_data['parsed_at'] = $transcript_row->parsed_at;
            
            error_log('‚úÖ Transcript found for session: ' . $session_id . ' (' . $transcript_row->message_count . ' messages)');
        } else {
            error_log('‚ö†Ô∏è No transcript found for session: ' . $session_id);
        }
        
        wp_send_json_success($response_data);
    }
    
    /**
     * AJAX handler to get session metadata from Anam API
     */
    public function get_session_metadata() {
        if (!check_ajax_referer('anam_session', 'nonce', false)) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        $session_id = isset($_POST['sessionId']) ? sanitize_text_field($_POST['sessionId']) : '';
        
        if (empty($session_id)) {
            wp_send_json_error('Session ID is required');
            return;
        }
        
        $options = get_option('anam_options', array());
        $api_key = isset($options['api_key']) ? $options['api_key'] : '';
        
        if (empty($api_key)) {
            wp_send_json_error('API Key not configured');
            return;
        }
        
        $api_url = 'https://api.anam.ai/v1/sessions/' . urlencode($session_id);
        
        $response = wp_remote_get($api_url, array(
            'headers' => array(
                'Authorization' => 'Bearer ' . $api_key,
                'Content-Type' => 'application/json'
            ),
            'timeout' => 15
        ));
        
        if (is_wp_error($response)) {
            wp_send_json_error('Failed to fetch session metadata: ' . $response->get_error_message());
            return;
        }
        
        $status_code = wp_remote_retrieve_response_code($response);
        $body = wp_remote_retrieve_body($response);
        
        if ($status_code !== 200) {
            wp_send_json_error('API returned error: ' . $status_code);
            return;
        }
        
        $data = json_decode($body, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            wp_send_json_error('Failed to parse API response');
            return;
        }
        
        wp_send_json_success($data);
    }
    
    /**
     * AJAX handler to save transcript data
     */
    public function save_transcript() {
        // Verify nonce
        if (!check_ajax_referer('anam_session', 'nonce', false)) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        $session_id = isset($_POST['session_id']) ? sanitize_text_field($_POST['session_id']) : '';
        $transcript_data = isset($_POST['transcript_data']) ? $_POST['transcript_data'] : '';
        
        if (empty($session_id)) {
            wp_send_json_error('Session ID is required');
            return;
        }
        
        if (empty($transcript_data)) {
            wp_send_json_error('Transcript data is required');
            return;
        }
        
        // Decode and validate transcript data
        $messages = json_decode(stripslashes($transcript_data), true);
        if (!$messages || !is_array($messages)) {
            error_log('‚ùå Invalid transcript data received');
            error_log('Raw data: ' . substr($transcript_data, 0, 200));
            wp_send_json_error('Invalid transcript data');
            return;
        }
        
        // Re-encode as clean JSON for storage
        $clean_json = json_encode($messages);
        
        global $wpdb;
        $table_name = $wpdb->prefix . 'anam_transcripts';
        
        // Check if transcript already exists for this session
        $existing = $wpdb->get_row($wpdb->prepare(
            "SELECT id FROM $table_name WHERE session_id = %s",
            $session_id
        ));
        
        $message_count = count($messages);
        
        if ($existing) {
            // Update existing transcript
            $result = $wpdb->update(
                $table_name,
                array(
                    'transcript_data' => $clean_json,
                    'message_count' => $message_count,
                    'updated_at' => current_time('mysql')
                ),
                array('session_id' => $session_id),
                array('%s', '%d', '%s'),
                array('%s')
            );
        } else {
            // Insert new transcript
            $result = $wpdb->insert(
                $table_name,
                array(
                    'session_id' => $session_id,
                    'transcript_data' => $clean_json,
                    'message_count' => $message_count,
                    'created_at' => current_time('mysql'),
                    'updated_at' => current_time('mysql')
                ),
                array('%s', '%s', '%d', '%s', '%s')
            );
        }
        
        if ($result === false) {
            error_log('‚ùå Failed to save transcript: ' . $wpdb->last_error);
            wp_send_json_error('Database error: ' . $wpdb->last_error);
            return;
        }
        
        error_log('‚úÖ Transcript saved for session: ' . $session_id . ' (' . $message_count . ' messages)');
        
        // Send email notification if enabled and this is a new transcript
        if (!$existing) {
            $this->send_session_notification($session_id, $message_count);
        }
        
        wp_send_json_success(array(
            'message' => 'Transcript saved successfully',
            'session_id' => $session_id,
            'message_count' => $message_count
        ));
    }
    
    /**
     * Send email notification when a session completes
     */
    private function send_session_notification($session_id, $message_count) {
        // Always send to WordPress admin email
        $admin_email = get_option('admin_email');
        
        if (empty($admin_email)) {
            return;
        }
        
        // Build the email
        $site_name = get_bloginfo('name');
        $transcripts_url = admin_url('admin.php?page=anam-sessions&view_session=' . urlencode($session_id));
        
        $subject = sprintf('[%s] New Chat Session Completed', $site_name);
        
        $message = "A new chat session has been completed on your website.\n\n";
        $message .= "Session Details:\n";
        $message .= "- Session ID: {$session_id}\n";
        $message .= "- Message Count: {$message_count}\n";
        $message .= "- Time: " . current_time('mysql') . "\n\n";
        $message .= "View the full transcript here:\n";
        $message .= $transcripts_url . "\n\n";
        $message .= "---\n";
        $message .= "This is an automated notification from {$site_name}";
        
        $headers = array('Content-Type: text/plain; charset=UTF-8');
        
        // Send the email
        $sent = wp_mail($admin_email, $subject, $message, $headers);
        
        if ($sent) {
            error_log('‚úÖ Session notification email sent to: ' . $admin_email);
        } else {
            error_log('‚ùå Failed to send session notification email');
        }
    }
    
    /**
     * AJAX handler to parse transcript and send to Google AI Studio
     */
    public function parse_transcript() {
        if (!check_ajax_referer('anam_session', 'nonce', false)) {
            wp_send_json_error('Security check failed');
            return;
        }
        
        $session_id = isset($_POST['sessionId']) ? sanitize_text_field($_POST['sessionId']) : '';
        
        if (empty($session_id)) {
            wp_send_json_error('Session ID is required');
            return;
        }
        
        // Get transcript from database
        global $wpdb;
        $table_name = $wpdb->prefix . 'anam_transcripts';
        
        $transcript_row = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $table_name WHERE session_id = %s",
            $session_id
        ));
        
        if (!$transcript_row) {
            wp_send_json_error('Transcript not found');
            return;
        }
        
        // Check if already parsed
        if ($transcript_row->parsed) {
            wp_send_json_error('This transcript has already been parsed on ' . $transcript_row->parsed_at);
            return;
        }
        
        $transcript_data = json_decode($transcript_row->transcript_data, true);
        
        if (!$transcript_data) {
            wp_send_json_error('Invalid transcript data');
            return;
        }
        
        // Get session metadata if provided
        $session_metadata = isset($_POST['sessionMetadata']) ? json_decode(stripslashes($_POST['sessionMetadata']), true) : null;
        
        // Build payload for Google AI Studio
        $payload = array(
            'session_id' => $session_id,
            'transcript' => $transcript_data,
            'session_metadata' => $session_metadata,
            'user_profile' => array(
                'first_name' => 'Nick',
                'last_name' => 'Patterson',
                'phone' => '(912) 233-1234'
            ),
            'timestamp' => current_time('c')
        );
        
        // Get parser endpoint URL from settings
        $options = get_option($this->option_name, array());
        $parser_url = isset($options['parser_endpoint_url']) ? $options['parser_endpoint_url'] : 'https://iegsoumvmhvvhmdyxhxs.supabase.co/functions/v1/key-value-processor';
        
        if (empty($parser_url)) {
            wp_send_json_error('Parser endpoint URL not configured. Please set it in Database Integration settings.');
            return;
        }
        
        $response = wp_remote_post($parser_url, array(
            'headers' => array(
                'Content-Type' => 'application/json'
            ),
            'body' => json_encode($payload),
            'timeout' => 60
        ));
        
        if (is_wp_error($response)) {
            wp_send_json_error('Failed to connect to parser: ' . $response->get_error_message());
            return;
        }
        
        $response_code = wp_remote_retrieve_response_code($response);
        $response_body = wp_remote_retrieve_body($response);
        
        error_log('Parser response code: ' . $response_code);
        error_log('Parser response body: ' . substr($response_body, 0, 500));
        
        if ($response_code !== 200) {
            // Try to extract meaningful error from HTML if present
            $error_msg = 'Parser returned error code ' . $response_code;
            if (strpos($response_body, '<html') !== false) {
                $error_msg .= ' (HTML error page returned - parser may be down)';
            } else {
                $error_msg .= ': ' . substr($response_body, 0, 200);
            }
            wp_send_json_error($error_msg);
            return;
        }
        
        // Mark transcript as parsed
        $updated = $wpdb->update(
            $table_name,
            array(
                'parsed' => 1,
                'parsed_at' => current_time('mysql')
            ),
            array('session_id' => $session_id),
            array('%d', '%s'),
            array('%s')
        );
        
        if ($updated === false) {
            error_log('‚ùå Failed to mark transcript as parsed for session: ' . $session_id);
        } else {
            error_log('‚úÖ Transcript marked as parsed for session: ' . $session_id);
        }
        
        wp_send_json_success(array(
            'message' => 'Transcript parsed successfully',
            'parser_response' => json_decode($response_body, true),
            'parsed_at' => current_time('mysql')
        ));
    }

    /**
     * AJAX handler to reset plugin to default state
     */
    public function reset_plugin() {
        // Verify nonce
        if (!check_ajax_referer('anam_session', 'nonce', false)) {
            wp_send_json_error('Security check failed');
            return;
        }

        global $wpdb;
        
        // 1. Clear ALL options from wp_options
        delete_option('anam_options');
        error_log('üóëÔ∏è RESET: Deleted all plugin options from wp_options');
        
        // 2. Clear ALL transcripts from wp_anam_transcripts table
        $table_name = $wpdb->prefix . 'anam_transcripts';
        $deleted = $wpdb->query("TRUNCATE TABLE {$table_name}");
        error_log('üóëÔ∏è RESET: Cleared all transcripts from database');
        
        // 3. Set transient for success notice
        set_transient('anam_reset_notice', true, 45);
        
        wp_send_json_success(array(
            'message' => 'Plugin reset successfully. All settings and transcripts have been cleared.',
            'redirect' => admin_url('admin.php?page=anam-settings')
        ));
    }
    
    /**
     * Disable page caching for pages with avatar
     */
    public function disable_page_caching() {
        if (!$this->should_show_avatar()) {
            return;
        }
        
        // Set headers to prevent caching
        header('Cache-Control: no-cache, no-store, must-revalidate, max-age=0');
        header('Pragma: no-cache');
        header('Expires: 0');
    }

}


new AnamAdminSettings();

/**
 * Render the sessions page with sessions list
 */
function anam_render_sessions_page() {
    $options = get_option('anam_options', array());
    $api_key = isset($options['api_key']) ? $options['api_key'] : '';
    $persona_id = isset($options['persona_id']) ? $options['persona_id'] : '';
    
    ?>
    <div class="wrap">
        <h1>üí¨ Chat Transcripts</h1>
        
        <?php if (empty($api_key) || empty($persona_id)): ?>
            <div class="notice notice-warning">
                <p><strong>Configuration Required:</strong> Please configure your API Key and Persona ID in <a href="<?php echo admin_url('admin.php?page=anam-settings'); ?>">Avatar Setup</a> first.</p>
            </div>
        <?php else: ?>
            <div class="notice notice-info">
                <p>Displaying sessions for Persona ID: <code><?php echo esc_html($persona_id); ?></code> | <a href="<?php echo admin_url('admin.php?page=anam-settings'); ?>">Avatar Setup</a></p>
            </div>
            
            <div id="sessions-loading" style="text-align: center; padding: 40px;">
                <div class="anam-spinner" style="margin: 0 auto 20px; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0073aa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p>Loading sessions...</p>
            </div>
            
            <div id="sessions-error" style="display: none;">
            </div>
            
            <div id="sessions-container" style="display: none; max-width: 1440px;">
                <table class="wp-list-table widefat fixed striped">
                    <thead>
                        <tr>
                            <th style="width: 300px;">Session ID</th>
                            <th style="width: 150px;">Session Start</th>
                            <th style="width: 150px;">Session End</th>
                            <th>Client Label</th>
                            <th style="width: 100px; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-list">
                        <!-- Sessions will be loaded here -->
                    </tbody>
                </table>
                
                <div id="sessions-pagination" style="margin-top: 20px; text-align: center;">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        <?php endif; ?>
        
        <!-- Session Details Modal -->
        <div id="session-details-modal" style="display: none; position: fixed; z-index: 100000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 1200px; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0;">Chat Details</h2>
                    <button id="close-session-modal" style="background: none; border: none; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</button>
                </div>
                <div class="nav-tab-wrapper" style="margin: 0; border-bottom: 1px solid #ddd;">
                    <a href="#" class="nav-tab" data-tab="session-json">Session JSON</a>
                    <a href="#" class="nav-tab nav-tab-active" data-tab="transcript" style="background: white;">Transcript</a>
                    <a href="#" class="nav-tab" data-tab="transcript-json">Transcript JSON</a>
                </div>
                <div id="session-details-content" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px;">
                        <div class="anam-spinner" style="margin: 0 auto 20px; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0073aa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p>Loading session details...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            #session-details-modal pre {
                background: #f5f5f5;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
                font-size: 12px;
                line-height: 1.5;
            }
        </style>
    </div>
    <?php
}
